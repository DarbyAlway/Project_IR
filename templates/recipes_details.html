<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recipe Details</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='recipes_details.css') }}"
    />
    <style>
     
    </style>
    <script>
      let currentRating = 0;

      function setRating(rating) {
        currentRating = rating;

        // Update the visual appearance of stars
        const stars = document.querySelectorAll('.star');
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add('selected');
          } else {
            star.classList.remove('selected');
          }
        });

        // Show feedback based on rating
        const feedback = document.getElementById("rating-feedback");
        feedback.innerText = `You rated this recipe: ${rating} star${rating > 1 ? 's' : ''}`;
      }

      function showBookmarkPopup() {
        // Show the popup
        document.getElementById("bookmark-popup").style.display = "block";

        // Fetch the user's bookmark folders from the server
        fetch("/bookmark/folders", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        })
          .then((response) => response.json())
          .then((data) => {
            // Populate the folder dropdown
            const folderSelect = document.getElementById("existing-folder");
            folderSelect.innerHTML = ""; // Clear existing options

            // If there are no folders, show a message (optional)
            if (data.folders.length === 0) {
              const option = document.createElement("option");
              option.value = "";
              option.text = "No folders available";
              folderSelect.appendChild(option);
            } else {
              // Populate dropdown with folder names
              data.folders.forEach((folder) => {
                const option = document.createElement("option");
                option.value = folder;
                option.text = folder;
                folderSelect.appendChild(option);
              });
            }
          })
          .catch((error) => console.error("Error fetching folders:", error));
      }

      function closeBookmarkPopup() {
        document.getElementById("bookmark-popup").style.display = "none";
      }

      function chooseFolderType(type) {
        if (type === "existing") {
          document.getElementById("existing-folder-container").style.display =
            "block";
          document.getElementById("new-folder-container").style.display =
            "none";
        } else {
          document.getElementById("existing-folder-container").style.display =
            "none";
          document.getElementById("new-folder-container").style.display =
            "block";
        }
      }

      function saveToExistingFolder() {
        const folderName = document.getElementById("existing-folder").value;
        const recipeId = "{{ recipe['RecipeId'] }}";
        const recipeName = "{{ recipe['Name'] }}";
        const recipeImage = "{{ recipe['Images'] }}";
        const recipeDescription = "{{ recipe['Description'] }}";

        if (!folderName) {
          alert("Please select an existing folder.");
          return;
        }

        fetch("/bookmark/existing", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            folder_name: folderName,
            recipe_id: recipeId,
            recipe_name: recipeName,
            recipe_image: recipeImage,
            recipe_description: recipeDescription,
            rating: currentRating,

          }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            closeBookmarkPopup();
          })
          .catch((error) => console.error("Error:", error));
      }

      function saveToNewFolder() {
        const folderName = document.getElementById("new-folder").value.trim();
        const recipeId = "{{ recipe['RecipeId'] }}";
        const recipeName = "{{ recipe['Name'] }}";
        const recipeImage = "{{ recipe['Images'] }}";
        const recipeDescription = "{{ recipe['Description'] }}";

        if (!folderName) {
          alert("Please enter a new folder name.");
          return;
        }

        fetch("/bookmark/new", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            folder_name: folderName,
            recipe_id: recipeId,
            recipe_name: recipeName,
            recipe_image: recipeImage,
            recipe_description: recipeDescription,
            rating: currentRating,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            closeBookmarkPopup();
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
  </head>
  <body>
    <h1>Recipe Details</h1>

    <div class="recipe-container">
      <h2>{{ recipe['Name'] }}</h2>
      <p>
        <strong>Description:</strong> {{ recipe['Description'] | default('No
        description available') }}
      </p>
      <p>
        <strong>Ingredients:</strong> {{ recipe['RecipeIngredientParts'] |
        default('No ingredients available') }}
      </p>
      <p>
        <strong>Instructions:</strong> {{ recipe['RecipeInstructions'] |
        default('No instructions available') }}
      </p>

      {% if recipe['Images'] %}
      <img src="{{ recipe['Images'] }}" alt="{{ recipe['Name'] }}" />
      {% else %}
      <p>No image available for this recipe.</p>
      {% endif %}

      <div class="button-container">
        <a href="/mainpage" class="button back-link">Back to Search</a>
        <button class="button bookmark-btn" onclick="showBookmarkPopup()">
          Bookmark
        </button>
      </div>
    </div>

    <!-- Bookmark Popup -->
    <div id="bookmark-popup" class="popup">
      <h3>Save to Bookmark</h3>

      <div class="folder-options">
        <button class="btn-existing" onclick="chooseFolderType('existing')">
          Existing Folder
        </button>
        <button class="btn-new" onclick="chooseFolderType('new')">
          New Folder
        </button>
      </div>
      <!-- Rating Section -->
      <div id="rating-container">
        <h4>Rate this Recipe</h4>
        <div class="rating-stars">
          <span class="star" onclick="setRating(1)">&#9733;</span>
          <span class="star" onclick="setRating(2)">&#9733;</span>
          <span class="star" onclick="setRating(3)">&#9733;</span>
          <span class="star" onclick="setRating(4)">&#9733;</span>
          <span class="star" onclick="setRating(5)">&#9733;</span>
        </div>
        <p id="rating-feedback">No rating yet.</p>
      </div>


      <div id="existing-folder-container" style="display: none">
        <h4>Select Folder</h4>
        <select id="existing-folder">
          {% for folder in user_folders %}
          <option value="{{ folder }}">{{ folder }}</option>
          {% endfor %}
        </select>
        <button onclick="saveToExistingFolder()">Save to Existing Folder</button>
      </div>

      <div id="new-folder-container" style="display: none">
        <h4>Enter New Folder Name</h4>
        <input type="text" id="new-folder" placeholder="New folder name" />
        <button onclick="saveToNewFolder()">Save to New Folder</button>
      </div>

    
      <br />
      <button class="close-btn" onclick="closeBookmarkPopup()">Close</button>
    </div>
  </body>
</html>
